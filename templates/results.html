<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EV Charging Stations â€” Results</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-1:#07181a; --bg-2:#082b27; --panel:rgba(255,255,255,0.03);
      --muted:#cfeee6; --accent:#12b886; --glass:rgba(255,255,255,0.02);
    }
    html,body{height:100%;width:100vw;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--muted);overflow:hidden}

    /* Topbar */
    .topbar{position:fixed;left:0;right:0;top:0;height:68px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(255,255,255,0.02));backdrop-filter:blur(6px);z-index:90;border-bottom:1px solid rgba(255,255,255,0.03)}
    .brand{font-weight:700;color:var(--accent);font-size:1.05rem}
    .meta{color:rgba(255,255,255,0.78);font-size:0.95rem}

    /* App frame: two equal columns */
    .app-frame{display:grid;grid-template-columns:2fr 1fr;gap:6px;padding:0;height:calc(100vh - 68px);margin-top:68px;box-sizing:border-box}

    .map-panel{background:var(--glass);border-radius:12px;border:1px solid rgba(255,255,255,0.03);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    #map{flex:1;min-height:420px}
    .map-footer{padding:10px 14px;font-size:13px;color:rgba(255,255,255,0.72);display:flex;justify-content:space-between;align-items:center}

    .panel-right{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,0.6);overflow:auto;min-height:0}
    .panel-right.hide{display:none}

    .panel-title{margin:0 0 10px 0;color:var(--accent);font-size:1.05rem}
    .results-list{display:flex;flex-direction:column;gap:12px}

    .station-card{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);transition:transform .12s ease,box-shadow .12s ease}
    .station-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.45);cursor:pointer}
    .station-left{display:flex;flex-direction:column}
    .station-name{font-weight:650;color:#e9fff7}
    .station-sub{font-size:0.9rem;color:rgba(255,255,255,0.74)}
    .station-right{text-align:right}
    .distance-badge{background:linear-gradient(90deg,var(--accent),#06a173);color:#021914;padding:6px 10px;border-radius:8px;font-weight:700}

    .footer{margin-top:14px;text-align:center;color:rgba(255,255,255,0.6)}

    /* Floating chat */
    .chat-toggle{position:fixed;right:22px;bottom:22px;z-index:120;background:linear-gradient(180deg,var(--accent),#0b8a63);border:none;color:#021914;padding:14px;border-radius:999px;box-shadow:0 12px 40px rgba(0,0,0,0.6);cursor:pointer}
    .chat-panel{position:fixed;right:22px;bottom:86px;width:420px;max-height:80vh;background:#081614;color:var(--muted);border-radius:12px;padding:12px;box-shadow:0 24px 60px rgba(0,0,0,0.6);display:none;flex-direction:column;z-index:120}
    .chat-messages{flex:1;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:8px}
    .chat-input{display:flex;gap:8px;margin-top:8px}
    .chat-input textarea{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--muted);resize:none}
    .chat-send{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;color:#021914;font-weight:700;cursor:pointer}

    @media (max-width: 980px){.app-frame{grid-template-columns:1fr;}.panel-right{order:2;width:100%}.topbar{padding:0 12px}}
  </style>
</head>
<body>

  <header class="topbar">
    <div class="brand">âš¡ EV Finder</div>
    <div class="meta">Showing {{ stations|length if stations else 0 }} stations â€” click a result to center the map</div>
    <div style="display:flex;gap:8px;align-items:center">
      <a href="/" class="btn" style="background:var(--accent);color:#021914;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:700">New Search</a>
      <button id="panel-toggle" class="btn" style="background:#0e8f6f;color:#021914;padding:8px 10px;border-radius:8px;border:none;cursor:pointer">Toggle</button>
    </div>
  </header>

  <main class="app-frame">
    <section class="map-panel">
      <div id="map"></div>
      <div class="map-footer"><div>Leaflet | Â© OpenStreetMap contributors</div><div style="font-size:13px;color:rgba(255,255,255,0.7)">EV Finder</div></div>
    </section>

    <aside id="panelRight" class="panel-right">
      <h2 class="panel-title">Results (Nearest Stations)</h2>
      {% if error %}<div style="color:#ffb4a2;margin-bottom:8px">{{ error }}</div>{% endif %}

      <div class="results-list" id="results-list">
        {% if stations and stations|length > 0 %}
          {% for s in stations %}
            <div class="station-card" data-lat="{{ s.lat }}" data-lon="{{ s.lon }}">
              <div class="station-left">
                <div class="station-name">{{ s.name }}</div>
                <div class="station-sub">{{ s.address }} â€¢ {{ s.city }}</div>
              </div>
              <div class="station-right"><div class="distance-badge">{{ "%.2f"|format(s.distance) }} km</div></div>
            </div>
          {% endfor %}
        {% else %}
          <div style="padding:8px;color:rgba(255,255,255,0.72)">No stations found for this query.</div>
        {% endif %}
      </div>

      <div class="footer">âš¡ Powered by Clean Energy | Drive Green ðŸŒ±</div>
    </aside>
  </main>

  <!-- data as JSON to avoid Jinja inside script issues -->
  <script id="stations-data" type="application/json">{{ stations|tojson }}</script>
  <script id="query-data" type="application/json">{{ {'lat': query_lat, 'lon': query_lon}|tojson }}</script>

  <button id="chat-toggle" class="chat-toggle" aria-label="Open chat">ðŸ’¬</button>
  <div id="chat-panel" class="chat-panel" role="dialog" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>EV Assistant</strong><button id="chat-close" style="background:transparent;border:none;color:var(--muted);font-size:16px;cursor:pointer">âœ–</button></div>
    <div id="chat-messages" class="chat-messages" aria-live="polite"><div style="font-size:12px;opacity:0.8">Ask about stations, directions, or tips.</div></div>
    <div class="chat-input"><textarea id="chat-input" rows="1" placeholder="Ask the EV Assistant..."></textarea><button id="chat-send" class="chat-send">Send</button></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const stations = JSON.parse(document.getElementById('stations-data').textContent || 'null');
    const query = JSON.parse(document.getElementById('query-data').textContent || 'null');

    // initial center
    let center = [20,0];
    if (query && query.lat !== null && query.lon !== null) center = [query.lat, query.lon];
    else if (stations && stations.length) center = [stations[0].lat, stations[0].lon];

    const map = L.map('map').setView(center, 11);
    const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles Â© Esri' });
    L.control.layers({Street: street, Satellite: sat}).addTo(map);

    const markers = [];
    const bounds = L.latLngBounds();

    if (query && query.lat !== null && query.lon !== null) bounds.extend([query.lat, query.lon]);

    if (stations && stations.length) {
      stations.forEach(s => {
        const lat = parseFloat(s.lat);
        const lon = parseFloat(s.lon);
        if (Number.isFinite(lat) && Number.isFinite(lon)){
          const m = L.marker([lat, lon]).addTo(map).bindPopup(`<b>${s.name}</b><br>${s.address}<br>${s.city}<br><b>Distance</b>: ${parseFloat(s.distance).toFixed(2)} km`);
          markers.push({lat, lon, marker:m});
          bounds.extend([lat, lon]);
        }
      });
    }

    if (bounds.isValid()) map.fitBounds(bounds.pad(0.16));

    // card <-> marker interaction
    document.querySelectorAll('.station-card').forEach(card=>{
      card.addEventListener('click', ()=>{
        const lat = parseFloat(card.dataset.lat);
        const lon = parseFloat(card.dataset.lon);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        const found = markers.find(m=>m.lat===lat && m.lon===lon);
        if (found){ map.setView([lat,lon],14,{animate:true}); found.marker.openPopup(); }
        document.querySelectorAll('.station-card.active').forEach(n=>n.classList.remove('active'));
        card.classList.add('active');
      });
    });

    // panel toggle
    const panelToggle = document.getElementById('panel-toggle');
    const panelRight = document.getElementById('panelRight');
    panelToggle.addEventListener('click', ()=>{ panelRight.classList.toggle('hide'); setTimeout(()=>map.invalidateSize(),350); });

    // CHAT: simple floating chat that posts to /chat
    async function postChat(message){
      try{
        const r = await fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message})});
        return await r.json();
      }catch(e){console.error(e);return {error: e.toString()}};
    }

    function appendChat(role,text){ const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.justifyContent=role==='user'?'flex-end':'flex-start'; const b=document.createElement('div'); b.textContent=text; b.style.padding='8px 10px'; b.style.borderRadius='10px'; b.style.maxWidth='78%'; b.style.fontSize='13px'; if(role==='user'){ b.style.background='linear-gradient(90deg,var(--accent),#06a173)'; b.style.color='#021914'; } else { b.style.background='rgba(255,255,255,0.03)'; b.style.color='var(--muted)'; } wrap.appendChild(b); document.getElementById('chat-messages').appendChild(wrap); document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight; }

    const chatToggle = document.getElementById('chat-toggle');
    const chatPanel = document.getElementById('chat-panel');
    const chatClose = document.getElementById('chat-close');
    const chatSend = document.getElementById('chat-send');
    const chatInput = document.getElementById('chat-input');

    chatToggle.addEventListener('click', ()=>{ if (chatPanel.style.display==='flex'){ chatPanel.style.display='none'; chatPanel.setAttribute('aria-hidden','true'); } else { chatPanel.style.display='flex'; chatPanel.setAttribute('aria-hidden','false'); chatInput.focus(); } });
    chatClose.addEventListener('click', ()=>{ chatPanel.style.display='none'; chatPanel.setAttribute('aria-hidden','true'); });

    async function sendChat(){ const t=chatInput.value.trim(); if(!t) return; appendChat('user',t); chatInput.value=''; const loading=document.createElement('div'); loading.textContent='...'; appendChat('bot','...'); const res = await postChat(t); // remove the last loading
      const msgs = document.getElementById('chat-messages'); if(msgs.lastChild && msgs.lastChild.textContent==='...') msgs.lastChild.remove();
      let reply = '';
      if (res){ if (res.candidates && res.candidates.length) reply = res.candidates[0].content.parts[0].text; else if (res.output) reply = JSON.stringify(res.output); else if (res.error) reply = 'âš ï¸ '+(res.error.message||res.error); else reply = JSON.stringify(res); }
      appendChat('bot', reply);
    }

    chatSend.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); } });

  </script>
</body>
</html>
